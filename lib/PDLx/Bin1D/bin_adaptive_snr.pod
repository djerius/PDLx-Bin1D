=head2 bin_adaptive_snr

=for usage

  %hash = bin_adaptive_snr( $signal, [ \%options ]  );

=for ref

Adaptively bin a data set using errors to achieve minimum signal to
noise ratios in each bin.

This routine ignores data with bad values or with errors that have
bad values.

B<bin_snr> groups data into bins such that each bin achieves a minimum
signal to noise ratio (S/N).  The data are typically dependent values
(e.g. flux as a function of energy or counts as a function of radius).
The data should be sorted by the independent variable (e.g. energy or
radius).

Binning begins at the start of the data vector.  Data are accumulated
into a bin until the minimum S/N (specified by the B<min_sn> option)
is met.  The signal is the sum of the data and the noise is the RSS
error in the bin.  If the final bin has insufficient S/N, it is folded
into the previous bin.

The noise is typically provided by the caller as a piddle containing
errors or squared errors.  It may also be calculated on the fly as either
the standard deviation of the signal in a bin, or as the Poisson error
in the number of counts in a bin.

Additional constraints may be placed upon how the data are binned:

=over

=item *

Number of elements

The minimum and/or maximum number of data elements assigned to a bin
may be constrained.

=item *

weight

Each datum may be assigned an additional weight; the sum of those
values in a bin may be bounded.

=back


=head3 Options

Options are parsed by PDL::Options, so unique abbreviations are accepted.

=over

=item error

This may be one of the following:

=over

=item *

a piddle (same dimensions as the signal piddle)

This should contain the error for each element of the signal. If the
C<error_squared> option is set, this contains the I<square> of the
error.

=item *

The string C<poisson>, indicating that Poisson errors should be
calculated, namely

   N / sqrt(N)

where I<N> is the number of data elements placed in a bin.  To treat
the input signal as counts, and calculate Poisson errors from them,
set C<error> equal to the signal piddle, and set the C<error_squared>
option to a true value.

=item *

The string C<sdev>, indicating that the standard deviation of the
signal in the bin should be used as the error. The standard deviation
is calculated as

  ( Sum( S**2 ) + ( Sum(S) / N )**2 * ( 1 - 2 N ) ) / ( N - 1 )

where I<S> is the signal in a bin and I<N> is the number of data
elements placed in the bin.  This may suffer overflow.

=back

=item fold (boolean)

If true, the last bin may be folded into the preceding bin in order to
ensure that the last bin achieves the requested SNR.  If this is not
specified, it will be set to true if the C<nmax> or C<wmax> options
are not set, otherwise it will be false.

=item nmin (default: 1 )

The minimum number of elements per bin

=item nmax (default: 0 )

The maximum number of elements per bin; set to zero for no limit.

=item wmin (default: 0 )

=item wmax (default: 0 )

The minimum and maximum weight for a bin; set to zero for no limit.
These options require that the C<weight> option also be set.

=item weight

A piddle containting the "weight" of each datum.  It must have the same
dimensions as the input data.

=back

=head3 Results

B<bin_err> returns a hash with the following entries:

=over

=item C<bin>

A piddle containing the bin indices for the elements in the input
data piddle.  Data which were skipped because of bad values will have
their index set to the bad value.

=item C<sum>

A piddle containing the sum of the data values in each bin.

=item C<nelem>

A piddle containing the number of data elements in each bin.

=item C<sigma>

A piddle containing the RSS of the errors in each bin.

=item C<weight>

A piddle containing the weight of each bin.  It will be empty
if no input weight constraints were specified.

=item C<ifirst>

A piddle containing the index into the input data piddle of the first
data value in a bin.

=item C<ilast>

A piddle containing the index into the input data piddle of the last
data value in a bin.

=item C<rc>

A piddle containing a results code for each output bin.  The code is
the bitwise "or" of the following constants (available in the
C<CXC::PDL::Bin1D> namespace)

=over

=item BIN_OK

The bin met the minimum S/N, data element count and weight requirements

=item BIN_GEWMAX

The bin weight was greater or equal to that requested.

=item BIN_GENMAX

The number of data elements was greater or equal to that requested.

=item BIN_FOLDED

The bin is the result of folding bins at the end of the bin vector to
achieve a minimum S/N.

=item BIN_GTMINSN

The bin accumulated more data elemetns than was necessary to meet the
S/N requirements.  This results from constraints on the minimum number
of data elements or bin weight.

=back

=back


=cut
